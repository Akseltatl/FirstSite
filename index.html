# -*- coding: utf-8 -*-
import pygame
import sys
import math

# Конфигурация
WIDTH, HEIGHT = 1200, 800
BG_COLOR = (20, 20, 20)
FPS = 60
MAX_SPEED = 10
ACCEL = 0.25
FRICTION = 0.05
TURN_SPEED = 4  # градусов за кадр

class Car:
    def __init__(self, x, y, color, name="Car"):
        self.x = x
        self.y = y
        self.angle = 0.0  # в градусах
        self.speed = 0.0
        self.color = color
        self.name = name
        self.image = self.create_image()
        self.rect = self.image.get_rect(center=(self.x, self.y))

    def create_image(self):
        # создаем простой спрайт автомобиля
        surf = pygame.Surface((60, 30), pygame.SRCALPHA)
        pygame.draw.rect(surf, self.color, (0, 0, 60, 30))
        pygame.draw.rect(surf, (0,0,0), (0,0,60,30), 2)
        return surf

    def update(self, dt, controls):
        # Управление: стрелки - вперед/назад и лево/право
        if controls['accel']:
            self.speed += ACCEL
        elif controls['brake']:
            self.speed -= ACCEL * 2
        else:
            # свободная физика: плавное затухание
            if self.speed > 0:
                self.speed -= FRICTION
            elif self.speed < 0:
                self.speed += FRICTION

        # ограничение скорости
        self.speed = max(-MAX_SPEED, min(self.speed, MAX_SPEED))

        # поворот в зависимости от скорости
        if controls['left']:
            self.angle -= TURN_SPEED * (1 + abs(self.speed) * 0.05)
        if controls['right']:
            self.angle += TURN_SPEED * (1 + abs(self.speed) * 0.05)

        # обновление положения
        rad = math.radians(self.angle)
        self.x += math.cos(rad) * self.speed
        self.y += math.sin(rad) * self.speed

        # обновление прямоугольника
        self.rect.center = (int(self.x), int(self.y))

    def draw(self, surface):
        rotated = pygame.transform.rotate(self.image, -self.angle)
        rect = rotated.get_rect(center=(self.x, self.y))
        surface.blit(rotated, rect.topleft)
        # имя над автомобилем
        font = pygame.font.SysFont(None, 20)
        text = font.render(self.name, True, self.color)
        text_rect = text.get_rect(center=(self.x, self.y - 25))
        surface.blit(text, text_rect)

def main():
    pygame.init()
    screen = pygame.display.set_mode((WIDTH, HEIGHT))
    pygame.display.set_caption("Свободное вождение автомобилей (GitHub-идеи)")
    clock = pygame.time.Clock()

    # Создаем несколько автомобилей
    cars = [
        Car(200, 200, CAR_COLORS[0], "Car A"),
        Car(400, 300, CAR_COLORS[1], "Car B"),
        Car(600, 200, CAR_COLORS[2], "Car C"),
        Car(800, 400, CAR_COLORS[3], "Car D"),
    ]

    # Контроли для каждого автомобиля (по умолчанию управляем ими через разные наборы клавиш)
    controls_list = []
    for i in range(len(cars)):
        controls_list.append({
            'accel': False,
            'brake': False,
            'left': False,
            'right': False,
        })

    # Хардкодируем карту/фон как единое поле без ограничений
    running = True
    while running:
        dt = clock.get_time() / 1000.0
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False

            # Пример: управляение для первого автомобиля клавишами WASD
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_w:
                    controls_list[0]['accel'] = True
                if event.key == pygame.K_s:
                    controls_list[0]['brake'] = True
                if event.key == pygame.K_a:
                    controls_list[0]['left'] = True
                if event.key == pygame.K_d:
                    controls_list[0]['right'] = True

                # Второй авто - Управление стрелками
                if len(cars) > 1:
                    if event.key == pygame.K_UP:
                        controls_list[1]['accel'] = True
                    if event.key == pygame.K_DOWN:
                        controls_list[1]['brake'] = True
                    if event.key == pygame.K_LEFT:
                        controls_list[1]['left'] = True
                    if event.key == pygame.K_RIGHT:
                        controls_list[1]['right'] = True

            if event.type == pygame.KEYUP:
                if event.key == pygame.K_w:
                    controls_list[0]['accel'] = False
                if event.key == pygame.K_s:
                    controls_list[0]['brake'] = False
                if event.key == pygame.K_a:
                    controls_list[0]['left'] = False
                if event.key == pygame.K_d:
                    controls_list[0]['right'] = False

                if len(cars) > 1:
                    if event.key == pygame.K_UP:
                        controls_list[1]['accel'] = False
                    if event.key == pygame.K_DOWN:
                        controls_list[1]['brake'] = False
                    if event.key == pygame.K_LEFT:
                        controls_list[1]['left'] = False
                    if event.key == pygame.K_RIGHT:
                        controls_list[1]['right'] = False

        # Обновление машин
        for i, car in enumerate(cars):
            car.update(dt, controls_list[i])

        # Рендер
        screen.fill(BG_COLOR)
        for car in cars:
            car.draw(screen)

        pygame.display.flip()
        clock.tick(FPS)

    pygame.quit()
    sys.exit()

if __name__ == "__main__":
    main()
