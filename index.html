import pygame
import sys
import random

# Инициализация
pygame.init()

# Настройки экрана
SCREEN_WIDTH = 800
SCREEN_HEIGHT = 600
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Car Driving Game")
clock = pygame.time.Clock()

# Цвета
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)
GRAY = (100, 100, 100)

# Физические параметры
MAX_SPEED = 10
ACCELERATION = 0.2
DECELERATION = 0.1
TURN_SPEED = 3  # градусов за кадр

# Пути к изображениям машин (должны быть в assets/cars/)
CAR_PATHS = [
    'assets/cars/car_blue.png',
    'assets/cars/car_red.png',
    'assets/cars/car_green.png'
]
BACKGROUND_PATH = 'assets/background/road.png'

def load_and_scale(path, scale=0.2):
    """Загружает и масштабирует изображение."""
    img = pygame.image.load(path)
    w, h = img.get_size()
    new_size = (int(w * scale), int(h * scale))
    return pygame.transform.scale(img, new_size)

def draw_text(text, font, color, surface, x, y):
    """Рисует текст на экране."""
    textobj = font.render(text, True, color)
    textrect = textobj.get_rect()
    textrect.topleft = (x, y)
    surface.blit(textobj, textrect)

def main():
    # Загружаем фон и машины
    try:
        background = pygame.image.load(BACKGROUND_PATH).convert()
        car_images = [load_and_scale(path) for path in CAR_PATHS]
    except pygame.error as e:
        print(f"Ошибка загрузки изображений: {e}")
        sys.exit(1)

    font = pygame.font.Font(None, 36)

    # Меню выбора машины
    selected = 0
    while True:
        screen.fill(GRAY)
        draw_text("Выберите машину (стрелки ← →, Enter)", font, WHITE, screen, 100, 100)
        
        # Рисуем превью машин
        for i, img in enumerate(car_images):
            x = 150 + i * 200
            y = 300
            screen.blit(img, (x, y))
            if i == selected:
                pygame.draw.rect(screen, WHITE, (x-5, y-5, img.get_width()+10, img.get_height()+10), 3)
        
        
        pygame.display.flip()
        
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_LEFT:
                    selected = (selected - 1) % len(car_images)
                if event.key == pygame.K_RIGHT:
                    selected = (selected + 1) % len(car_images)
                if event.key == pygame.K_RETURN:
                    break

    # Основная игра
    car_img = car_images[selected]
    car_rect = car_img.get_rect(center=(SCREEN_WIDTH // 2, SCREEN_HEIGHT // 2))
    speed = 0
    angle = 0

    running = True
    while running:
        # Обработка событий
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False

        # Управление
        keys = pygame.key.get_pressed()
        if keys[pygame.K_UP]:
            speed += ACCELERATION
        elif keys[pygame.K_DOWN]:
            speed -= DECELERATION
        else:
            # Естественное замедление
            if speed > 0:
                speed -= DECELERATION / 2
            elif speed < 0:
                speed += DECELERATION / 2

        if keys[pygame.K_LEFT]:
            angle += TURN_SPEED
        if keys[pygame.K_RIGHT]:
            angle -= TURN_SPEED


        # Ограничение скорости
        speed = max(-MAX_SPEED / 2, min(speed, MAX_SPEED))


        # Движение машины
        rad = pygame.math.Vector2(0, -1).rotate(angle).as_polar()[1]
        car_rect.x += speed * pygame.math.cos(rad)
        car_rect.y += speed * pygame.math.sin(rad)


        # Прокрутка фона (эффект движения)
        rel_y = car_rect.y % background.get_rect().height
        screen.blit(background, (0, rel_y - background.get_rect().height))
        if rel_y < SCREEN_HEIGHT:
            screen.blit(background, (0, rel_y))

        # Поворот и рисование машины
        rotated_img = pygame.transform.rotate(car_img, angle)
        rotated_rect = rotated_img.get_rect(center=car_rect.center)
        screen.blit(rotated_img, rotated_rect)

        # Отображение скорости
        speed_text = font.render(f!Speed: {abs(speed):.1f}", True, WHITE)
        screen.blit(speed_text, (10, 10))

        pygame.display.flip()
        clock.tick(60)  # 60 FPS


    pygame.quit()
    sys.exit()

if __name__ == "__main__":
    main()
